<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Economic Data Viewer - Multiple Countries</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 20px;
      color: #2c3e50;
    }
    header {
      background-color: #1abc9c;
      color: white;
      text-align: center;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
    }
    h1 {
      margin: 0;
      font-weight: 700;
    }
    #controls {
      max-width: 700px;
      margin: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-bottom: 30px;
    }
    select, input, button {
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      min-width: 180px;
      flex-grow: 1;
    }
    button {
      background-color: #1abc9c;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
      min-width: 200px;
      flex-grow: unset;
    }
    button:hover {
      background-color: #159a84;
    }
    #selectedCountries {
      max-width: 700px;
      margin: 10px auto 30px auto;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }
    .country-chip {
      background-color: #16a085;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: default;
    }
    .country-chip button {
      background: transparent;
      border: none;
      color: white;
      font-weight: 700;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      padding: 0;
      margin-left: 6px;
    }
    canvas {
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      display: block;
      margin: 0 auto 40px auto;
      max-width: 100%;
      height: 450px;
    }
    footer {
      background-color: #ecf0f1;
      border-radius: 5px;
      color: #2c3e50;
      font-weight: 600;
      text-align: center;
      padding: 15px;
      max-width: 700px;
      margin: auto;
    }
    .nav-single {
      display: block;
      text-align: center;
      margin-top: 20px;
      font-weight: 600;
      color: #1abc9c;
      text-decoration: none;
    }
    .nav-single:hover {
      text-decoration: underline;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <header>
    <h1>üåç Economic Data Viewer</h1>
    <p>Compare Multiple Countries - Powered by Econlens Data Lab</p>
  </header>

  <div id="controls">
    <select id="countrySelect" aria-label="Select country to add">
      <option value="">-- Select Country to Add --</option>
    </select>

    <select id="indicatorSelect" aria-label="Select indicator">
      <option value="NY.GDP.MKTP.KD.ZG">GDP Growth (%)</option>
      <option value="NY.GDP.PCAP.KD.ZG">GDP per capita Growth (%)</option>
      <option value="FP.CPI.TOTL.ZG">Inflation (% annual)</option>
      <option value="SL.UEM.TOTL.ZS">Unemployment (% total)</option>
      <option value="SP.POP.GROW">Population Growth (%)</option>
      <option value="NY.GDP.MKTP.CD">GDP (current US$)</option>
      <option value="SP.POP.TOTL">Total Population</option>
      <option value="NE.EXP.GNFS.CD">Exports of goods and services (current US$)</option>
      <option value="NE.IMP.GNFS.CD">Imports of goods and services (current US$)</option>
    </select>

    <input type="number" id="startYear" placeholder="Start Year" min="1960" max="2024" value="2000" aria-label="Start Year" />
    <input type="number" id="endYear" placeholder="End Year" min="1960" max="2024" value="2023" aria-label="End Year" />

    <select id="chartType" aria-label="Select chart type">
      <option value="line">Line</option>
      <option value="bar">Bar</option>
      <option value="scatter">Scatter</option>
    </select>

    <button id="addCountryBtn">‚ûï Add Country</button>
    <button id="showDataBtn">üìä Show Data</button>
    <button id="downloadExcelBtn">‚¨áÔ∏è Download Excel</button>
  </div>

  <div id="selectedCountries" aria-live="polite" aria-label="Selected countries"></div>

  <canvas id="dataChart"></canvas>

  <a href="single.html" class="nav-single" aria-label="Navigate to single country view page">
    ‚ûî Go to Single Country View
  </a>

  <footer>
    <p>¬© Econlens Data Lab ‚Äì Data sourced from World Bank. <br />Disclaimer: Data accuracy depends on the source. Use for academic and research purposes only.</p>
  </footer>

  <script>
    let countriesList = [];
    let selectedCountries = [];
    let chart;
    let excelData = [];

    async function populateCountries() {
      try {
        const res = await fetch('https://api.worldbank.org/v2/country?format=json&per_page=300');
        const json = await res.json();
        countriesList = json[1].filter(c => c.region.id !== "NA").sort((a, b) => a.name.localeCompare(b.name));
        const select = document.getElementById('countrySelect');
        countriesList.forEach(c => {
          const option = document.createElement('option');
          option.value = c.id;
          option.textContent = c.name;
          select.appendChild(option);
        });
      } catch (e) {
        alert("Failed to load countries data.");
      }
    }

    function renderSelectedCountries() {
      const container = document.getElementById('selectedCountries');
      container.innerHTML = '';
      selectedCountries.forEach(c => {
        const chip = document.createElement('div');
        chip.className = 'country-chip';
        chip.textContent = c.name;
        const btn = document.createElement('button');
        btn.setAttribute('aria-label', `Remove ${c.name}`);
        btn.innerHTML = '√ó';
        btn.onclick = () => {
          selectedCountries = selectedCountries.filter(sc => sc.id !== c.id);
          renderSelectedCountries();
        };
        chip.appendChild(btn);
        container.appendChild(chip);
      });
    }

    document.getElementById('addCountryBtn').addEventListener('click', () => {
      const select = document.getElementById('countrySelect');
      const selectedId = select.value;
      if (!selectedId) {
        alert('Please select a country to add.');
        return;
      }
      if (selectedCountries.some(c => c.id === selectedId)) {
        alert('Country already added.');
        return;
      }
      const country = countriesList.find(c => c.id === selectedId);
      if (country) {
        selectedCountries.push(country);
        renderSelectedCountries();
      }
    });

    async function fetchCountryData(countryId, indicator, startYear, endYear) {
      const url = `https://api.worldbank.org/v2/country/${countryId}/indicator/${indicator}?format=json&date=${startYear}:${endYear}&per_page=100`;
      try {
        const res = await fetch(url);
        const json = await res.json();
        if (!json[1] || json[1].length === 0) {
          return null;
        }
        return json[1].reverse();
      } catch {
        return null;
      }
    }

    async function fetchAllData() {
      const indicator = document.getElementById('indicatorSelect').value;
      const startYear = parseInt(document.getElementById('startYear').value);
      const endYear = parseInt(document.getElementById('endYear').value);
      const chartType = document.getElementById('chartType').value;

      if (selectedCountries.length === 0) {
        alert('Please add at least one country.');
        return;
      }
      if (isNaN(startYear) || isNaN(endYear) || startYear > endYear) {
        alert('Please enter a valid year range.');
        return;
      }

      excelData = [['Year']];
      const labelsSet = new Set();

      // Prepare datasets for chart.js
      const datasets = [];
      let indicatorName = '';
      for (const country of selectedCountries) {
        const data = await fetchCountryData(country.id, indicator, startYear, endYear);
        if (!data) {
          alert(`No data found for ${country.name}.`);
          continue;
        }
        if (!indicatorName && data.length > 0) {
          indicatorName = data[0].indicator.value;
        }

        const countryDataMap = new Map();
        data.forEach(record => {
          if (record.value !== null) {
            labelsSet.add(record.date);
            countryDataMap.set(record.date, record.value);
          }
        });

        datasets.push({
          label: country.name,
          data: Array.from(labelsSet).sort().map(year => countryDataMap.get(year) ?? null),
          borderColor: getRandomColor(),
          backgroundColor: 'transparent',
          fill: false,
          pointRadius: 4,
          showLine: chartType !== 'scatter',
        });
      }

      const labels = Array.from(labelsSet).sort();

      // Prepare excel data rows: first row headers
      excelData = [['Year', ...selectedCountries.map(c => c.name)]];
      for (const year of labels) {
        const row = [year];
        for (const dataset of datasets) {
          const idx = labels.indexOf(year);
          row.push(dataset.data[idx] ?? '');
        }
        excelData.push(row);
      }

      drawChart(labels, datasets, chartType, indicatorName);
    }

    function drawChart(labels, datasets, type, indicator) {
      const ctx = document.getElementById('dataChart').getContext('2d');
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: type,
        data: {
          labels: labels,
          datasets: datasets,
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: false,
              title: { display: true, text: indicator }
            },
            x: {
              title: { display: true, text: 'Year' }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => {
                  let val = ctx.raw;
                  if (val === null || val === undefined) return 'No data';
                  return val + (indicator.includes('%') ? '%' : '');
                }
              }
            }
          }
        }
      });
    }

    function getRandomColor() {
      // Returns a random tealish color for datasets
      const hues = [160, 170, 180, 190, 200, 210];
      const hue = hues[Math.floor(Math.random() * hues.length)];
      return `hsl(${hue}, 70%, 40%)`;
    }

    function downloadExcel() {
      if (!excelData.length || excelData.length === 1) {
        alert("No data to export. Please fetch data first.");
        return;
      }
      const worksheet = XLSX.utils.aoa_to_sheet(excelData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Data");
      const fileName = `EconData_Multiple_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(workbook, fileName);
    }

    document.getElementById('showDataBtn').addEventListener('click', fetchAllData);
    document.getElementById('downloadExcelBtn').addEventListener('click', downloadExcel);

    window.onload = populateCountries;
  </script>

</body>
</html>
